# 総合医療保険フローチャート 再設計ドラフト v2

## 1. 設計変更のポイント（v1 → v2）

- **必須モジュールを `01a_core_共通.md` と `01b_core_入院.md` に分割統合** — 全ケース共通のステップと入院ありケースのステップを分離
- **入院なしケース（手術のみ等）では `01b_core_入院.md` を読み込まない** — 不要な入院関連ステップの読み込みを完全排除
- **ルーターは `01b_core_入院.md` の要否 + 条件付きモジュール10個の判定に専念** — 判定ロジックが極めてシンプルに
- ファイル数: 25 → **13**（ルーター1 + コア2 + 条件付き10）

---

## 2. ファイル構成

```
総合医療保険_v2/
│
├── 00_router.md                      # 入院コア要否 + 条件付きモジュールの要否判定
├── 01a_core_共通.md                  # 全ケース共通ステップ（常に読み込み）
├── 01b_core_入院.md                  # 入院ありケースのみ読み込み（ルーター判定）
│
│ ── 条件付きモジュール ──
├── M01_がん群判定.md                  # 傷病CDが悪性新生物の場合のみ
├── M02_部位不担保.md                  # 部位不担保条件がある場合のみ
├── M03_災害入院給付金.md              # 事故情報がある場合のみ
├── M04_入院初期給付特約.md            # 入院初期給付特約が付加されている場合のみ
├── M05_併発判定.md                    # 同一入院に複数傷病がある場合のみ
├── M06_通算_災害.md                   # 災害入院が複数ある場合のみ
├── M07_通算_疾病31日特別.md           # 複数入院または既払入院がある場合のみ
├── M08_手術判定.md                    # 手術記載がある場合のみ
├── M09_被保険者不知.md                # 悪性新生物がある場合のみ
└── M10_特別取扱い比較.md              # Phase3実行後に動的判定
```

---

## 3. コアフローの2分割構成

### 3.1 01a_core_共通.md（常に読み込み）

| セクション | 対象step_id | ステップ数 | 統合理由 |
|-----------|-----------|----------|---------|
| 契約状態確認 | S1_1_1～S1_1_10 | 10 | 全ケース必須 |
| 商品特約判定 | S1_2_1～S1_2_8 | 14 | 全ケース必須（付加状況を記録） |
| 入院有無チェック | S1_3_1～S1_3_2 | 2 | 入院/手術のみ/REJECTの分岐点 |
| 確認要否 | S1F_1A～PHASE1_END | 20 | 全ケース必須（手術のみルートへの分岐含む） |
| 最終算定 | S31_1～S31_8 | 8 | 全ケース必須 |
| 特約判定準備 | S80_1～S80_ALL_END | 14 | 全ケース必須 |
| **合計** | | **約68ステップ** | |

### 3.2 01b_core_入院.md（入院ありの場合のみ読み込み ※ルーター判定）

| セクション | 対象step_id | ステップ数 | 統合理由 |
|-----------|-----------|----------|---------|
| 入院前提_治療目的 | S1B_LOOP～S1B_2_16 | 30 | 入院あれば必ず通る。がん群判定(M01)への分岐点(S1B_2_1A)を含む |
| 入院前提_施設責任開始 | S1B_3_1～S1B_OK/X/NEXT/END | 20 | 入院あれば必ず通る |
| 疾病入院給付金 | S6_LOOP～S6_X | 8 | 入院あれば必ず通る（災害判定後の疾病判定） |
| 入院給付金算定 | S12_1～S14_1 | 12 | 入院あれば必ず通る |
| **合計** | | **約70ステップ** | |
### 3.3 条件付きモジュール呼び出しポイント（全体フロー図）

```
===== 01a_core_共通.md（常に読み込み） =====
[契約状態確認] S1_1_1～S1_1_10
    ↓
[商品特約判定] S1_2_1～S1_2_8
    ↓
[入院有無チェック] S1_3_1～S1_3_2
    ├─ 入院あり → 01b_core_入院.md へ遷移
    └─ 入院なし → 手術有無チェック
        ├─ 手術あり → [確認要否] → ★ M08 → [最終算定] → [特約判定準備] → END
        └─ 手術なし → REJECT

===== 01b_core_入院.md（入院ありの場合のみ） =====
[入院前提_治療目的] S1B_LOOP～S1B_2_1A
    ↓ S1B_2_1AでYES（悪性新生物）
    ★ M01_がん群判定.md を読み込み・実行 → 結果を持って復帰
    ↓ S1B_2_1AでNO、またはM01復帰後
[入院前提_治療目的 続き] S1B_2_2～S1B_2_16
    ↓
[入院前提_施設責任開始] S1B_3_1～S1B_4_13, S1B_OK/X/NEXT/END
    ↓
    ★ M02_部位不担保.md （ルーターでLOAD判定済みの場合のみ実行）
    ↓

===== 01a_core_共通.md に復帰 =====
[確認要否] S1F_1A～S1F_OK_CHK
    ↓ PHASE1_END

===== 01b_core_入院.md の続き =====
    ★ M03_災害入院給付金.md （ルーターでLOAD判定済みの場合のみ実行）
    ↓
[疾病入院給付金] S6_LOOP～S6_X
    ↓
    ★ M04_入院初期給付特約.md （ルーターでLOAD判定済みの場合のみ実行）
    ↓
    ★ M05_併発判定.md （ルーターでLOAD判定済みの場合のみ実行）
    ↓ PHASE2_END
    ★ M06_通算_災害.md （ルーターでLOAD判定済みの場合のみ実行）
    ★ M07_通算_疾病31日特別.md （ルーターでLOAD判定済みの場合のみ実行）
    ↓ PHASE3_END
[入院給付金算定] S12_1～S14_1
    ↓ PHASE4_END

===== 01a_core_共通.md に復帰 =====
    ★ M08_手術判定.md （ルーターでLOAD判定済みの場合のみ実行）
    ↓
    ★ M09_被保険者不知.md （ルーターでLOAD判定済みの場合のみ実行）
    ↓ PHASE5_END
[最終算定] S31_1～S31_8
    ↓ PHASE6_END
    ★ M10_特別取扱い比較.md （01b内PHASE3_END直後の★M10_LOAD_CHKで動的判定済み）
    ↓
[特約判定準備] S80_1～S80_ALL_END
    ↓ END
```

---

## 4. 条件付きモジュール詳細

| ID | モジュール名 | 対象step_id | ステップ数 | 挿入ポイント |
|----|-----------|-----------|----------|------------|
| M01 | がん群判定 | S1B_G_i1～S1B_G_X | 32 | S1B_2_1A=YES時 |
| M02 | 部位不担保 | S1C_LOOP～S1C_END | 18 | S1B_END後 |
| M03 | 災害入院給付金 | S5_CHK～S5_X | 22 | PHASE1_END後 |
| M04 | 入院初期給付特約 | S9_CHK～S9_X | 14 | S6完了後 |
| M05 | 併発判定 | S10C_CHK～S10C_END | 30 | S9完了後 |
| M06 | 通算_災害 | S11_PRE～S11_1_4 | 7 | PHASE2_END後 |
| M07 | 通算_疾病31日特別 | S11_2_1～S11_6_5 | 37 | M06後またはPHASE2_END後 |
| M08 | 手術判定 | S20_CHK～S29_INC | 86 | PHASE4_END後 |
| M09 | 被保険者不知 | S30_CHK～S30_3 | 4 | M08完了後 |
| M10 | 特別取扱い比較 | S70_1～S79_END | 30 | 01b:PHASE3_END直後で動的判定（★M10_LOAD_CHK）。ルーター対象外 |
| **合計** | | | **280** | |

---

## 5. 00_router.md 改訂版

### ルーティングテーブル（条件付きモジュールのみ）

AIはインプットJSONの以下フィールドを機械的に参照し、各モジュールのLOAD/SKIPを判定する。

| モジュール | 参照フィールド | LOAD条件 |
|-----------|-------------|---------|
| M01_がん群判定 | `診断書[N].傷病[].傷病CD分類` | 「悪性新生物」を含む値が1件以上 |
| M02_部位不担保 | `契約情報.特別条件.特別条件有無` + `部位不担保[]` | `特別条件有無==true` AND `部位不担保[]`長 > 0 |
| M03_災害入院給付金 | `事故情報.事故発生日` | != null |
| M04_入院初期給付特約 | `付加商品特約.ライダー一覧[].名称` | 「入院初期給付特約」が存在 |
| M05_併発判定 | `診断書[N].傷病[].紐づけ区分` | 同一入院紐づけの傷病 > 1件 |
| M06_通算_災害 | M03=LOAD + 複数入院 | M03がLOAD AND (入院数>1 OR 既払に災害入院あり) |
| M07_通算_疾病31日特別 | `診断書[N].入院[]`長 + `既払情報[]` | 入院数>1 OR 既払に入院履歴あり |
| M08_手術判定 | `診断書[N].手術[]` | 配列長 > 0 |
| M09_被保険者不知 | M01=LOAD | M01がLOADの場合（悪性新生物あり） |
| M10_特別取扱い比較 | ※ルーター対象外 | 01b_core_入院.md内のPHASE3_END直後で動的判定（★M10_LOAD_CHK）。FLAG_抜釘/術後/多胎/産褥のいずれかON時にLOAD |

### 特記: M05（併発判定）のルーター判定について

M05は「同一入院中に災害傷病と疾病傷病が混在」等を判定するが、ルーター段階では厳密な判定が困難なケースがある。そのため以下の方針とする：

- **ルーターでは「可能性がある」ケースを広めに検出してLOADする**
- 具体的には: `同一紐づけ区分の傷病が2件以上` OR `事故情報あり AND 疾病傷病あり`
- M05の冒頭チェック(S10C_CHK)で実際に併発がなければ即スキップされるため、余分な読み込みコストは最小

### 特記: M07（通算系）の統合について

v1では通算_疾病180日・31日継続・特別取扱を3ファイルに分けていたが、以下の理由で1ファイルに統合：

- 疾病180日通算 → 31日継続 → 術後/多胎/産褥は一連の処理フローであり、途中で分割すると状態管理が複雑化
- 「複数入院 or 既払入院あり」という同一条件でLOAD/SKIPが決まる
- 統合しても37ステップと適切なサイズ

---

## 6. ケース別読み込み量の比較

| ケースパターン | 現行(6ファイル全量) | v2構成 | 読込ステップ数 | 削減率 |
|-------------|-----------------|--------|-------------|------|
| 単純疾病入院（手術なし） | ~540 | 01a + 01b | ~138 | **74%減** |
| 疾病入院＋手術 | ~540 | 01a + 01b + M08 | ~224 | **59%減** |
| がん入院＋手術 | ~540 | 01a + 01b + M01 + M08 + M09 | ~260 | **52%減** |
| 災害入院＋疾病併発＋手術 | ~540 | 01a + 01b + M03 + M05 + M08 | ~276 | **49%減** |
| 複数入院＋通算＋手術＋がん | ~540 | 01a + 01b + M01 + M07 + M08 + M09 | ~297 | **45%減** |
| フルスペック（全条件該当） | ~540 | 01a + 01b + M01～M10全部 | ~418 | **23%減** |
| **手術のみ（入院なし）** | ~540 | **01a + M08 のみ** | **~154** | **71%減** |

---

## 7. 入院なしケースのフロー

コアフローを01a（共通）と01b（入院）に分割したことで、入院なしケースでは01b_core_入院.mdを一切読み込まない。

### 入院なし・手術ありケースの実行パス

```
01a_core_共通.md:
  [契約状態確認] → [商品特約判定] → [入院有無チェック]
    → 入院なし → 手術あり
      → [確認要否]
      → ★ M08_手術判定.md
      → ★ M09_被保険者不知.md（がんの場合のみ）
      → [最終算定]
      → [特約判定準備]
      → END

読み込み: 01a(68) + M08(86) = 約154ステップ
01b_core_入院.md (70ステップ) は読み込まれない
```

### 入院なし・手術なしケース

```
01a_core_共通.md:
  [契約状態確認] → [商品特約判定] → [入院有無チェック]
    → 入院なし → 手術なし → REJECT

読み込み: 01a(68) のみ = 約68ステップ
```

---

## 8. 残課題

| # | 課題 | 優先度 | 対応方針 |
|---|-----|------|---------|
| 1 | ~~M08(手術判定)が86ステップと大きい~~ | ~~中~~ | **対応不要と確定**: 60日規定→同日同倍率→80番/82番/89番制限→同時手術→金額算定と前ステップ結果が後続に連鎖し分割は現実的でない。86ステップのまま1モジュールとして運用 |
| 2 | ~~コアフローの入院なし時スキップ効率~~ | ~~低~~ | **解決済み**: 01a/01b分割により入院なし時は01bを読み込まない |
| 3 | ~~M10(特別取扱い比較)の動的判定タイミング~~ | ~~中~~ | **解決済み**: ルーター対象外とし、01b_core_入院.md内のPHASE3_END直後に動的判定ステップ（★M10_LOAD_CHK）を追加。Phase3完了時点でFLAG_抜釘/術後/多胎/産褥を確認しいずれかONならM10を読み込み・実行。入院なしケース（01b未読み込み）ではM10は論理的に不要 |
| 4 | 査定プロンプトとの整合 | 次フェーズ | フローチャート完成後に改修 |

---

## 9. 次のステップ

1. ☐ **本ドラフトv2のレビュー・承認**
2. ☐ 01_core_flow.md の作成（現行TSVから必須ステップを切り出し・統合）
3. ☐ M01～M10 の作成（現行TSVから条件付きステップを切り出し）
4. ☐ 00_router.md の実装
5. ☐ テストケースでの動作検証
6. ☐ 査定プロンプトの改修（別フェーズ）
