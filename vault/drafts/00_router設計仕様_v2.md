# 00_router.md 設計仕様 ドラフト v2

## 概要

このルーターは、インプットデータ（JSON）のフィールドを機械的に参照し、当該ケースの査定に必要な**条件付きモジュール（M01～M10）のみ**を判定する。

**01_core_flow.md は常に全量読み込まれるため、ルーターの判定対象外。**

---

## 前提

- `01a_core_共通.md` はプロンプト側で常時読み込み指定（ルーター不要）
- ルーターが判定するのは `01b_core_入院.md` の要否 + 条件付きモジュール M01～M10 の LOAD/SKIP
- 全てインプットJSONのフィールドから機械的に判定（AI裁量なし）

---

## ルーティングテーブル

### STEP 0: 入院コアの判定

| # | モジュール | 参照フィールド | LOAD条件 |
|---|----------|-------------|---------|
| 01b | core_入院 | `診断書[N].入院[]` | 配列長 > 0（いずれかの診断書に入院あり） |

→ 01b = SKIP の場合、M01～M07 も自動的に SKIP（入院系モジュールは全て不要）
→ 01b = SKIP の場合、判定対象は M08, M09, M10 のみ

### STEP 1: 条件付きモジュールの判定

| # | モジュール | 参照フィールド | LOAD条件 |
|---|----------|-------------|---------|
| M01 | がん群判定 | `診断書[N].傷病[].傷病CD分類` | 「悪性新生物」を含む値が1件以上 |
| M02 | 部位不担保 | `契約情報.特別条件.特別条件有無` + `部位不担保[]` | `==true` AND 配列長 > 0 |
| M03 | 災害入院給付金 | `事故情報.事故発生日`, `事故情報.事故状況報告書` | `事故発生日 != null` OR `事故状況報告書 == true` |
| M04 | 入院初期給付特約 | `付加商品特約.ライダー一覧[].名称` | 「入院初期給付特約」が存在 |
| M05 | 併発判定 | `診断書[N].傷病[].紐づけ区分` | 同一入院紐づけの傷病 > 1件、またはM03=LOAD AND 疾病傷病あり |
| M06 | 通算_災害 | M03判定結果 + 入院数 + 既払情報 | M03=LOAD AND (`入院[]`長 > 1 OR 既払に災害入院あり) |
| M07 | 通算_疾病31日特別 | `診断書[N].入院[]`長 + `既払情報[].入院日` | 入院数 > 1 OR 既払に入院履歴あり |
| M08 | 手術判定 | `診断書[N].手術[]` | 配列長 > 0 |
| M09 | 被保険者不知 | M01判定結果 | M01 = LOAD（悪性新生物あり） |
| M10 | 特別取扱い比較 | ※ルーター対象外 | 01b_core_入院.md内 PHASE3_END直後の★M10_LOAD_CHKで動的判定 |

---

## 依存関係

一部のモジュールは他のモジュールの判定結果に依存する：

```
01b（core_入院）= SKIP → M01～M07 全て自動SKIP
M06（通算_災害）  ← M03（災害入院給付金）= LOAD が前提
M09（被保険者不知）← M01（がん群判定）= LOAD が前提
M10（特別取扱い比較）← ルーター対象外。01b内PHASE3_END直後で動的判定（★M10_LOAD_CHK）
```

---

## 出力形式

```
ADDITIONAL_MODULES:
- M03_災害入院給付金.md
- M08_手術判定.md

SKIPPED_MODULES:
- M01 → 傷病CD分類に悪性新生物なし
- M02 → 特別条件.部位不担保=空配列
- M04 → ライダー一覧に入院初期給付特約なし
- M05 → 同一入院に紐づく傷病=1件のみ
- M06 → M03=LOADだが入院1件・既払災害入院なし
- M07 → 入院1件・既払入院なし
- M09 → M01=SKIP（悪性新生物なし）

※ M10はルーター対象外（01b_core_入院.md内のPHASE3_END直後で動的判定）
```

---

## 実行フロー全体

```
1. AIがインプットデータ（JSON）を読み込む
2. AIが00_router.md を読み込み、01bの要否 + M01～M09のLOAD/SKIPを確定（M10はルーター対象外）
3. AIが01a_core_共通.md を読み込む（常時）
4. 01b=LOADの場合、01b_core_入院.md を読み込む
5. 各挿入ポイントで、LOADと判定されたモジュールを読み込み・実行
6. 01b内PHASE3_END直後の★M10_LOAD_CHKでFLAG確認→必要時のみM10を読み込み・実行
```

---

## ケースパターン別

### パターン1: 単純疾病入院のみ（手術なし）
```
01a(68) + 01b(70) + 追加なし → 約138ステップ （74%減）
```

### パターン2: がん入院＋手術
```
01a(68) + 01b(70) + M01(32) + M08(86) + M09(4) → 約260ステップ （52%減）
```

### パターン3: 災害入院＋疾病併発＋手術＋部位不担保
```
01a(68) + 01b(70) + M02(18) + M03(22) + M05(30) + M08(86) → 約294ステップ （46%減）
```

### パターン4: 手術のみ（入院なし）★01b読み込み不要
```
01a(68) + M08(86) → 約154ステップ （71%減）
01b_core_入院.md は読み込まない → 70ステップ節約
```

### パターン5: フルスペック（全条件該当）
```
01a(68) + 01b(70) + M01～M10全部(280) → 約418ステップ （23%減）
```
